% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/database_functions.R
\name{postgres_upsert_data}
\alias{postgres_upsert_data}
\title{postgres_upsert_data}
\usage{
postgres_upsert_data(
  con,
  schema,
  table,
  data,
  match_cols = NULL,
  delete_missing = FALSE,
  returning_cols = NULL,
  allow_manual_id = FALSE
)
}
\arguments{
\item{con}{An active database connection (e.g., created with \code{DBI::dbConnect()}).}

\item{schema}{The schema name in the database (e.g., "raw").}

\item{table}{The table name (e.g., "my_table" or "raw.my_table").}

\item{data}{A \code{data.frame} containing the data to be inserted or updated.}

\item{match_cols}{Character vector of column names used as conflict keys.}

\item{delete_missing}{Logical. If \code{TRUE}, rows that are no longer present in the data frame
will be deleted (based on the conflict keys).}

\item{returning_cols}{Optional character vector of columns to return after the UPSERT.}

\item{allow_manual_id}{Logical. If \code{TRUE}, the ID column can be manually provided in \code{data} and will be used
for insert/update operations. If \code{FALSE} (default), the ID column is excluded from updates.}
}
\value{
A \code{data.frame} with the returned columns (if \code{returning_cols} is set), otherwise \code{invisible(NULL)}.
}
\description{
Performs an UPSERT (insert or update) operation into a PostgreSQL table.
Optionally, rows that no longer exist in the provided data frame can be deleted,
and automatically generated IDs (e.g., serial) can be returned if requested.
}
\details{
\itemize{
\item If \code{match_cols} is not specified, the function looks for a typical ID column (e.g., "id").
\item Columns in \code{data} that do not exist in the target table are ignored with a warning.
\item Only columns other than \code{created_at}, \code{updated_at}, and \code{match_cols} are updated.
\item By default, the "id" column is excluded from updates. Set \code{allow_manual_id = TRUE} to include it.
\item A temporary table is created and used to perform the UPSERT.
\item If \code{delete_missing = TRUE}, all entries not found in the current data based on \code{match_cols} will be deleted.
}
}
\examples{
\dontrun{
  # Standard upsert with auto-generated IDs
  postgres_upsert_data(
    con = my_connection,
    schema = "raw",
    table = "my_table",
    data = my_dataframe,
    match_cols = c("id"),
    delete_missing = TRUE,
    returning_cols = c("id", "updated_at")
  )

  # Upsert with manually provided IDs (e.g., from external API)
  postgres_upsert_data(
    con = my_connection,
    schema = "raw",
    table = "makandra_companies",
    data = companies_from_api,  # contains 'id' column from API
    match_cols = c("id"),
    allow_manual_id = TRUE
  )
}

}
